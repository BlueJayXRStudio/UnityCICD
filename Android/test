#!/usr/bin/env bash
# -------------------------------------------------------------------
# remember to chmod +x test
# or use "bash test"
# -------------------------------------------------------------------

# Clean up past test results
FILES=(
  "results.xml"
  "results_edit_mode.xml"
  "Editor.log"
  "Editor_edit_mode.log"
  "logs/results.xml"
  "logs/results_edit_mode.xml"
  "logs/Editor.log"
  "logs/Editor_edit_mode.log"
)
for f in "${FILES[@]}"; do
  rm -f "$f"
done

# Exit immediately on error or unset variable
source ../envs/paths.env
set -euo pipefail

# Check that the environment variables are set
if [ -z "${UNITY_PATH:-}" ]; then
  echo "UNITY_PATH environment variable not set."
  echo "Example: export UNITY_PATH='/Applications/Unity/Hub/Editor/2022.3.9f1/Unity.app/Contents/MacOS/Unity'"
  exit 1
fi

if [ -z "${PROJECT_PATH_ANDROID:-}" ]; then
  echo "PROJECT_PATH_ANDROID environment variable not set."
  echo "Example: export PROJECT_PATH_ANDROID='/Users/username/MyUnityProject'"
  exit 1
fi

# Optional: Output paths for clarity
echo "Using Unity from: $UNITY_PATH"
echo "Project path: $PROJECT_PATH_ANDROID"

# Pull from origin/main
CURRENT_DIRECTORY="$(pwd)"
echo
echo "pulling from origin/main"

echo
echo "switching from:"
echo "$CURRENT_DIRECTORY"

cd "$PROJECT_PATH_ANDROID"

echo
echo "switched to:"
echo "$(pwd)"

echo
git restore .
git pull origin main
echo
echo "successfully pulled from origin/main"

echo
echo "switching back from:"
echo "$(pwd)"

cd "$CURRENT_DIRECTORY"

echo
echo "switched back to:"
echo "$(pwd)"


# START PROCEDURES
echo
echo "Starting test runners"

# Run Unity in batch mode with PlayMode tests
"$UNITY_PATH" \
  -batchmode \
  -projectPath "$PROJECT_PATH_ANDROID" \
  -runTests -testPlatform PlayMode \
  -testResults "$(pwd)/logs/results.xml" \
  -logFile "$(pwd)/logs/Editor.log"

# Capture exit code
EXIT_CODE=$?

if [ $EXIT_CODE -ne 0 ]; then
  echo "Unity tests failed with exit code $EXIT_CODE."
  exit 1
fi
echo
echo "PlayMode test successful"

# Run Unity in batch mode with PlayMode tests
"$UNITY_PATH" \
  -batchmode \
  -projectPath "$PROJECT_PATH_ANDROID" \
  -runTests -testPlatform EditMode \
  -testResults "$(pwd)/logs/results_edit_mode.xml" \
  -logFile "$(pwd)/logs/Editor_edit_mode.log"

# Capture exit code
EXIT_CODE=$?

if [ $EXIT_CODE -ne 0 ]; then
  echo "Unity tests failed with exit code $EXIT_CODE."
  exit 1
fi
echo
echo "EditMode test successful"

echo
if [ -f "results.xml" ]; then
  echo "results.xml created!"
fi
if [ -f "results_edit_mode.xml" ]; then
  echo "results_edit_mode.xml created!"
fi

exit 0