#!/usr/bin/env bash
# -------------------------------------------------------------------
# remember to chmod +x test
# or use "bash test"
# -------------------------------------------------------------------

# Resolve the absolute path of this script
SCRIPT_PATH="$(realpath "$0")"
SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"
LOGS_DIR="$SCRIPT_DIR/logs"
# Clean up past test results
FILES=(
  "$SCRIPT_DIR/results.xml"
  "$SCRIPT_DIR/results_edit_mode.xml"
  "$SCRIPT_DIR/Editor.log"
  "$SCRIPT_DIR/Editor_edit_mode.log"
  "$LOGS_DIR/results.xml"
  "$LOGS_DIR/results_edit_mode.xml"
  "$LOGS_DIR/Editor.log"
  "$LOGS_DIR/Editor_edit_mode.log"
)
for f in "${FILES[@]}"; do
  rm -f "$f"
done

# Exit immediately on error or unset variable
source "$(dirname "$SCRIPT_DIR")/envs/paths.env"
set -euo pipefail

# Check that the environment variables are set
if [ -z "${UNITY_PATH:-}" ]; then
  echo "UNITY_PATH environment variable not set."
  echo "Example: export UNITY_PATH='/Applications/Unity/Hub/Editor/2022.3.9f1/Unity.app/Contents/MacOS/Unity'"
  exit 1
fi

if [ -z "${PROJECT_PATH_MACOS:-}" ]; then
  echo "PROJECT_PATH_MACOS environment variable not set."
  echo "Example: export PROJECT_PATH_MACOS='/Users/username/MyUnityProject'"
  exit 1
fi

# Optional: Output paths for clarity
echo "Using Unity from: $UNITY_PATH"
echo "Project path: $PROJECT_PATH_MACOS"

# START PROCEDURES
echo
echo "Starting test runners"

# Run Unity in batch mode with PlayMode tests
set +e
"$UNITY_PATH" \
  -batchmode \
  -projectPath "$PROJECT_PATH_MACOS" \
  -runTests -testPlatform PlayMode \
  -testResults "$LOGS_DIR/results.xml" \
  -logFile "$LOGS_DIR/Editor.log"
# Capture exit code
EXIT_CODE=$?
set -e

if [ $EXIT_CODE -ne 0 ]; then
  echo "Unity tests failed with exit code $EXIT_CODE."
  exit 1
fi
echo
echo "PlayMode test successful"

# Run Unity in batch mode with EditMode tests
set +e
"$UNITY_PATH" \
  -batchmode \
  -projectPath "$PROJECT_PATH_MACOS" \
  -runTests -testPlatform EditMode \
  -testResults "$LOGS_DIR/results_edit_mode.xml" \
  -logFile "$LOGS_DIR/Editor_edit_mode.log"
# Capture exit code
EXIT_CODE=$?
set -e

if [ $EXIT_CODE -ne 0 ]; then
  echo "Unity tests failed with exit code $EXIT_CODE."
  exit 1
fi
echo
echo "EditMode test successful"

echo
if [ -f "$LOGS_DIR/results.xml" ]; then
  echo "results.xml created!"
fi
if [ -f "$LOGS_DIR/results_edit_mode.xml" ]; then
  echo "results_edit_mode.xml created!"
fi

exit 0